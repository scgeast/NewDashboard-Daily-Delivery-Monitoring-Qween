<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Delivery Monitoring</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* CSS yang sudah ada (tetap sama) */
    :root {
      --primary: #3498db;
      --secondary: #f8f9fa;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --header-bg: #2c3e50;
      --kpi-bg: #3498db;
      --kpi-text: white;
      --sidebar-bg: #4a5568;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      display: flex;
      flex-direction: row;
      min-height: 100vh;
    }

    /* SIDEBAR */
    #sidebar {
      width: 280px;
      background-color: var(--sidebar-bg);
      color: white;
      transition: all 0.3s ease;
      overflow: hidden;
      z-index: 1000;
      height: 100vh;
      position: fixed;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      border-right: 1px solid #ddd;
    }

    #sidebar.collapsed {
      width: 60px;
    }

    #sidebar-header {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #toggle-btn {
      position: absolute;
      top: 15px;
      right: -25px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 1001;
    }

    #sidebar-content {
      padding: 20px;
      height: calc(100vh - 60px);
      overflow-y: auto;
      overflow-x: hidden;
    }

    .filter-group {
      margin-bottom: 20px;
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .filter-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 0.9em;
      color: #4a5568;
    }

    .upload-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s;
      border: 2px dashed #e2e8f0;
      position: relative;
    }

    .upload-section:hover {
      border-color: var(--primary);
      background-color: #f7fafc;
    }

    .upload-section.drag-over {
      border-color: var(--primary);
      background-color: #e6f7ff;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .upload-text {
      color: #4a5568;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .upload-subtext {
      color: #a0aec0;
      font-size: 0.8rem;
    }

    .upload-section input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      cursor: pointer;
    }

    .filter-group select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      background-color: white;
      color: #4a5568;
      font-size: 0.9rem;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }

    .filter-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .filter-group input[type="date"] {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      background-color: white;
      color: #4a5568;
      font-size: 0.9rem;
    }

    .date-range {
      display: flex;
      gap: 10px;
    }

    .date-range input {
      flex: 1;
    }

    .toggle-section {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toggle-label {
      color: #4a5568;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e0;
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: #4299e1;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    .upload-status {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      display: none;
      text-align: center;
    }

    .upload-status.success {
      background-color: #f0fff4;
      color: #38a169;
      border: 1px solid #9ae6b4;
      display: block;
    }

    .upload-status.error {
      background-color: #fed7d7;
      color: #e53e3e;
      border: 1px solid #feb2b2;
      display: block;
    }

    .upload-status.processing {
      background-color: #e6f7ff;
      color: #1890ff;
      border: 1px solid #91d5ff;
      display: block;
    }

    .debug-panel {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 10px;
      margin-top: 10px;
      font-size: 0.75rem;
      color: #6c757d;
      max-height: 150px;
      overflow-y: auto;
      display: none;
    }

    /* MAIN CONTENT */
    #main-content {
      flex: 1;
      margin-left: 280px;
      padding: 20px;
      transition: margin-left 0.3s ease;
    }

    #main-content.sidebar-collapsed {
      margin-left: 60px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background-color: var(--header-bg);
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 1.8rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header h1 i {
      font-size: 1.5rem;
    }

    .last-update {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .periode {
      margin-bottom: 20px;
      font-size: 1.1rem;
      color: #555;
    }

    .kpi-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .kpi-card {
      background: var(--kpi-bg);
      color: var(--kpi-text);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      text-align: center;
      transition: transform 0.2s;
    }

    .kpi-card:hover {
      transform: translateY(-3px);
    }

    .kpi-card h3 {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.8);
      margin-bottom: 10px;
    }

    .kpi-card p {
      font-size: 1.8rem;
      font-weight: bold;
      color: white;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }

    .tab-btn {
      padding: 12px 24px;
      background: #f1f1f1;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: var(--primary);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .chart-container {
      margin-bottom: 30px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      min-height: 300px;
      position: relative;
    }

    .chart-title {
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: var(--dark);
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }

    .no-data-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #999;
      font-size: 1rem;
      text-align: center;
    }

    .footer {
      text-align: center;
      padding: 15px;
      color: #777;
      font-size: 0.9rem;
      margin-top: 30px;
      border-top: 1px solid #eee;
    }

    /* Responsive */
    @media (max-width: 768px) {
      #sidebar {
        width: 60px;
      }
      #main-content {
        margin-left: 60px;
      }
      .header h1 {
        font-size: 1.5rem;
      }
      .kpi-card p {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div id="sidebar">
    <div id="sidebar-header">
    </div>
    <button id="toggle-btn"><<</button>

    <div id="sidebar-content">
      <div class="upload-section" id="upload-area">
        <div class="upload-icon">
          <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <div class="upload-text">Drag & Drop Excel File</div>
        <div class="upload-text">or Click to Upload</div>
        <div class="upload-subtext">Min: 2KB | Max: 30MB</div>
        <input type="file" id="excel-file" accept=".xlsx,.xls" />
        <div class="upload-status" id="upload-status"></div>
        <div class="debug-panel" id="debug-panel"></div>
      </div>

      <div class="filter-group">
        <label>Date Range</label>
        <div class="date-range">
          <input type="date" id="start-date" />
          <input type="date" id="end-date" />
        </div>
      </div>

      <div class="filter-group">
        <label>Area</label>
        <select id="filter-area">
          <option value="all">Select All</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Plant</label>
        <select id="filter-plant">
          <option value="all">Select All</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Truck Type</label>
        <select id="filter-truck-type">
          <option value="all">Select All</option>
        </select>
      </div>

      <div class="toggle-section">
        <div class="toggle-label">Data Label On/Off</div>
        <label class="toggle-switch">
          <input type="checkbox" id="data-label-toggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content">
    <div class="header">
      <h1><i class="fas fa-hard-hat"></i> Summary Daily Delivery...Area (All)</h1>
      <div class="last-update" id="last-update">Last update: --</div>
    </div>

    <div class="periode" id="periode">Periode: --</div>

    <div class="kpi-container">
      <div class="kpi-card">
        <h3>Total Area</h3>
        <p id="kpi-area">0</p>
      </div>
      <div class="kpi-card">
        <h3>Total Plant</h3>
        <p id="kpi-plant">0</p>
      </div>
      <div class="kpi-card">
        <h3>Total Volume (m³)</h3>
        <p id="kpi-volume">0</p>
      </div>
      <div class="kpi-card">
        <h3>Avg Volume (m³)</h3>
        <p id="kpi-avg-volume">0</p>
      </div>
      <div class="kpi-card">
        <h3>Total Truck</h3>
        <p id="kpi-truck">0</p>
      </div>
      <div class="kpi-card">
        <h3>Avg Load / Truck</h3>
        <p id="kpi-avg-load">0</p>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="logistic">LOGISTIC</button>
      <button class="tab-btn" data-tab="sales">SALES AND CUSTOMER PERFORMANCE</button>
    </div>

    <!-- TAB 1: LOGISTIC -->
    <div id="tab-logistic" class="tab-content active">
      <h2 class="chart-title">A. Delivery</h2>
      
      <div id="chart-volume-by-area" class="chart-container" style="display:none;">
        <h3 class="chart-title">Volume by Area</h3>
        <canvas id="canvas-volume-area"></canvas>
        <div class="no-data-message" id="no-data-area" style="display:none;">No data available</div>
      </div>

      <div id="chart-volume-by-plant" class="chart-container">
        <h3 class="chart-title">Volume by Plant</h3>
        <canvas id="canvas-volume-plant"></canvas>
        <div class="no-data-message" id="no-data-plant" style="display:none;">No data available</div>
      </div>

      <div id="chart-avg-volume-by-plant" class="chart-container">
        <h3 class="chart-title">Avg Volume by Plant</h3>
        <canvas id="canvas-avg-volume-plant"></canvas>
        <div class="no-data-message" id="no-data-avg-plant" style="display:none;">No data available</div>
      </div>

      <div id="chart-avg-volume-per-day" class="chart-container">
        <h3 class="chart-title">Avg Volume per Day</h3>
        <canvas id="canvas-avg-volume-day"></canvas>
        <div class="no-data-message" id="no-data-day" style="display:none;">No data available</div>
      </div>

      <h2 class="chart-title">B. Utilization Truck</h2>

      <div id="chart-volume-per-truck" class="chart-container">
        <h3 class="chart-title">Volume per Truck</h3>
        <canvas id="canvas-volume-truck"></canvas>
        <div class="no-data-message" id="no-data-truck" style="display:none;">No data available</div>
      </div>

      <div id="chart-total-trip-per-truck" class="chart-container">
        <h3 class="chart-title">Total Trip per Truck</h3>
        <canvas id="canvas-trip-truck"></canvas>
        <div class="no-data-message" id="no-data-trip" style="display:none;">No data available</div>
      </div>

      <div id="chart-avg-load-per-truck" class="chart-container">
        <h3 class="chart-title">Avg Load per Truck</h3>
        <canvas id="canvas-avg-load-truck"></canvas>
        <div class="no-data-message" id="no-data-load" style="display:none;">No data available</div>
      </div>

      <h2 class="chart-title">C. Distance</h2>

      <div id="chart-avg-distance-per-plant" class="chart-container">
        <h3 class="chart-title">Avg Distance per Plant</h3>
        <canvas id="canvas-avg-distance-plant"></canvas>
        <div class="no-data-message" id="no-data-distance" style="display:none;">No data available</div>
      </div>

      <div id="chart-trend-volume-by-distance" class="chart-container">
        <h3 class="chart-title">Trend Volume by Distance</h3>
        <canvas id="canvas-trend-distance"></canvas>
        <div class="no-data-message" id="no-data-trend" style="display:none;">No data available</div>
      </div>
    </div>

    <!-- TAB 2: SALES -->
    <div id="tab-sales" class="tab-content">
      <h2 class="chart-title">A. Volume per Sales</h2>
      <div class="chart-container">
        <canvas id="canvas-volume-sales"></canvas>
        <div class="no-data-message" id="no-data-sales" style="display:none;">No data available</div>
      </div>

      <h2 class="chart-title">B. Volume per End Customer</h2>
      <div class="chart-container">
        <canvas id="canvas-volume-customer"></canvas>
        <div class="no-data-message" id="no-data-customer" style="display:none;">No data available</div>
      </div>
    </div>

    <div class="footer">
      Summary Daily Delivery And Sales by L=23-51Xe.
    </div>
  </div>

  <script>
    // Global Data
    let rawData = [];
    let filteredData = [];
    let charts = {};
    let highlightColors = [
      '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
      '#1abc9c', '#e67e22', '#2980b9', '#d35400', '#c0392b'
    ];

    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggle-btn');
    const mainContent = document.getElementById('main-content');
    const uploadArea = document.getElementById('upload-area');
    const excelFile = document.getElementById('excel-file');
    const uploadStatus = document.getElementById('upload-status');
    const debugPanel = document.getElementById('debug-panel');
    const dashboardTitle = document.querySelector('.header h1');
    const lastUpdate = document.getElementById('last-update');
    const periode = document.getElementById('periode');
    
    // KPI Elements
    const kpiArea = document.getElementById('kpi-area');
    const kpiPlant = document.getElementById('kpi-plant');
    const kpiVolume = document.getElementById('kpi-volume');
    const kpiAvgVolume = document.getElementById('kpi-avg-volume');
    const kpiTruck = document.getElementById('kpi-truck');
    const kpiAvgLoad = document.getElementById('kpi-avg-load');

    // Filter Elements
    const filterArea = document.getElementById('filter-area');
    const filterPlant = document.getElementById('filter-plant');
    const filterTruckType = document.getElementById('filter-truck-type');
    const startDate = document.getElementById('start-date');
    const endDate = document.getElementById('end-date');
    const dataLabelToggle = document.getElementById('data-label-toggle');

    // Tab Elements
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    // Initialize
    init();

    function init() {
      log('Initializing application...');
      setupEventListeners();
      updateLastUpdateTime();
      log('Application initialized successfully');
    }

    function log(message) {
      console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
      if (debugPanel) {
        debugPanel.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
        debugPanel.scrollTop = debugPanel.scrollHeight;
        debugPanel.style.display = 'block';
      }
    }

    function setupEventListeners() {
      log('Setting up event listeners...');
      
      // Sidebar toggle
      if (toggleBtn) {
        toggleBtn.addEventListener('click', toggleSidebar);
      }
      
      // File upload
      if (excelFile) {
        excelFile.addEventListener('change', function(e) {
          log('File input change detected');
          handleFileUpload(e);
        });
      }

      // Upload area click
      if (uploadArea && excelFile) {
        uploadArea.addEventListener('click', function(e) {
          log('Upload area clicked');
          if (e.target === excelFile) return; // Prevent double trigger
          excelFile.click();
        });
      }

      // Filter event listeners
      const filterElements = [filterArea, filterPlant, filterTruckType, startDate, endDate];
      filterElements.forEach(el => {
        if (el) {
          el.addEventListener('change', function() {
            log(`Filter changed: ${el.id}`);
            applyFilters();
          });
        }
      });

      // Data label toggle
      if (dataLabelToggle) {
        dataLabelToggle.addEventListener('change', function() {
          log('Data label toggle changed');
          redrawAllCharts();
        });
      }

      // Tab switching
      tabButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          log(`Tab switched to: ${btn.dataset.tab}`);
          tabButtons.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          const targetTab = document.getElementById(`tab-${btn.dataset.tab}`);
          if (targetTab) {
            targetTab.classList.add('active');
          }
          redrawAllCharts();
        });
      });

      // Drag and drop setup
      setupDragAndDrop();
      
      log('Event listeners setup completed');
    }

    function setupDragAndDrop() {
      if (!uploadArea) return;
      
      log('Setting up drag and drop...');

      // Prevent default drag behavior
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      // Highlight drop area
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, function() {
          uploadArea.classList.add('drag-over');
          log('Drag over detected');
        }, false);
      });

      // Remove highlight
      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, function() {
          uploadArea.classList.remove('drag-over');
          log('Drag leave/drop detected');
        }, false);
      });

      // Handle drop
      uploadArea.addEventListener('drop', function(e) {
        log('Files dropped');
        handleDrop(e);
      }, false);
    }

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      log(`Files dropped: ${files.length}`);
      
      if (files.length > 0) {
        const file = files[0];
        log(`File: ${file.name} (${file.size} bytes)`);
        
        // Set file to input element
        if (excelFile) {
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          excelFile.files = dataTransfer.files;
          handleFileUpload();
        }
      }
    }

    function toggleSidebar() {
      if (sidebar && mainContent && toggleBtn) {
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('sidebar-collapsed');
        toggleBtn.textContent = sidebar.classList.contains('collapsed') ? '>>' : '<<';
        log('Sidebar toggled');
      }
    }

    function updateLastUpdateTime() {
      if (lastUpdate) {
        const now = new Date();
        lastUpdate.textContent = `Last update: ${now.toLocaleString()}`;
      }
    }

    function showUploadStatus(message, type) {
      if (uploadStatus) {
        uploadStatus.textContent = message;
        uploadStatus.className = `upload-status ${type}`;
        
        if (type !== 'processing') {
          setTimeout(() => {
            uploadStatus.style.display = 'none';
          }, 5000);
        }
      }
      log(`Upload status: ${type} - ${message}`);
    }

    function handleFileUpload(event = null) {
      if (!excelFile || !excelFile.files || excelFile.files.length === 0) {
        log('No file selected');
        showUploadStatus("No file selected", "error");
        return;
      }

      const file = excelFile.files[0];
      log(`Processing file: ${file.name} (${file.size} bytes, ${file.type})`);

      // Validate file size
      if (file.size < 2 * 1024) {
        showUploadStatus("File must be at least 2KB!", "error");
        return;
      }
      
      if (file.size > 30 * 1024 * 1024) {
        showUploadStatus("File must be less than 30MB!", "error");
        return;
      }

      // Validate file type
      const validTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-excel'
      ];
      
      if (!validTypes.includes(file.type) && !file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
        showUploadStatus("Please upload a valid Excel file!", "error");
        return;
      }

      showUploadStatus("Processing file...", "processing");

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          log('File read successfully, parsing data...');
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // Get first worksheet
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          log(`Excel file parsed successfully. Rows: ${jsonData.length}`);
          
          // Process the data
          processExcelData(jsonData);
          showUploadStatus("File uploaded and processed successfully!", "success");
          
        } catch (error) {
          log(`Error processing file: ${error.message}`);
          showUploadStatus("Error processing file: " + error.message, "error");
        }
      };
      
      reader.onerror = function() {
        log('Error reading file');
        showUploadStatus("Error reading file", "error");
      };
      
      reader.readAsArrayBuffer(file);
    }

    function processExcelData(data) {
      if (!data || data.length < 2) {
        log('No data or insufficient rows in Excel file');
        showUploadStatus("No valid data found in Excel file", "error");
        return;
      }

      // Extract headers (first row)
      const headers = data[0];
      log(`Headers: ${headers.join(', ')}`);
      
      // Convert to array of objects
      rawData = [];
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (row.length === 0) continue;
        
        const obj = {};
        headers.forEach((header, index) => {
          obj[header] = row[index] !== undefined ? row[index] : null;
        });
        rawData.push(obj);
      }
      
      log(`Processed ${rawData.length} rows of data`);
      
      // Update filters
      updateFilters();
      
      // Apply initial filters and update dashboard
      applyFilters();
    }

    function updateFilters() {
      // Clear existing options
      filterArea.innerHTML = '<option value="all">Select All</option>';
      filterPlant.innerHTML = '<option value="all">Select All</option>';
      filterTruckType.innerHTML = '<option value="all">Select All</option>';
      
      // Get unique values for each filter
      const areas = [...new Set(rawData.map(item => item.Area))].filter(Boolean);
      const plants = [...new Set(rawData.map(item => item.Plant))].filter(Boolean);
      const truckTypes = [...new Set(rawData.map(item => item['Truck Type']))].filter(Boolean);
      
      // Add options to filters
      areas.forEach(area => {
        const option = document.createElement('option');
        option.value = area;
        option.textContent = area;
        filterArea.appendChild(option);
      });
      
      plants.forEach(plant => {
        const option = document.createElement('option');
        option.value = plant;
        option.textContent = plant;
        filterPlant.appendChild(option);
      });
      
      truckTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        filterTruckType.appendChild(option);
      });
      
      // Set date range
      const dates = rawData.map(item => item.Date).filter(Boolean);
      if (dates.length > 0) {
        const minDate = new Date(Math.min(...dates.map(d => new Date(d))));
        const maxDate = new Date(Math.max(...dates.map(d => new Date(d))));
        
        startDate.valueAsDate = minDate;
        endDate.valueAsDate = maxDate;
        
        periode.textContent = `Periode: ${formatDate(minDate)} - ${formatDate(maxDate)}`;
      }
      
      log(`Filters updated: ${areas.length} areas, ${plants.length} plants, ${truckTypes.length} truck types`);
    }

    function applyFilters() {
      log('Applying filters...');
      
      // Start with all data
      filteredData = [...rawData];
      
      // Apply area filter
      const selectedArea = filterArea.value;
      if (selectedArea !== 'all') {
        filteredData = filteredData.filter(item => item.Area === selectedArea);
        dashboardTitle.innerHTML = `<i class="fas fa-hard-hat"></i> Summary Daily Delivery...Area (${selectedArea})`;
      } else {
        dashboardTitle.innerHTML = `<i class="fas fa-hard-hat"></i> Summary Daily Delivery...Area (All)`;
      }
      
      // Apply plant filter
      const selectedPlant = filterPlant.value;
      if (selectedPlant !== 'all') {
        filteredData = filteredData.filter(item => item.Plant === selectedPlant);
      }
      
      // Apply truck type filter
      const selectedTruckType = filterTruckType.value;
      if (selectedTruckType !== 'all') {
        filteredData = filteredData.filter(item => item['Truck Type'] === selectedTruckType);
      }
      
      // Apply date filter
      const start = startDate.valueAsDate;
      const end = endDate.valueAsDate;
      
      if (start && end) {
        filteredData = filteredData.filter(item => {
          const itemDate = new Date(item.Date);
          return itemDate >= start && itemDate <= end;
        });
        
        periode.textContent = `Periode: ${formatDate(start)} - ${formatDate(end)}`;
      }
      
      log(`Data filtered: ${filteredData.length} rows remaining`);
      
      // Update KPIs and charts
      updateKPIs();
      updateCharts();
    }

    function updateKPIs() {
      if (filteredData.length === 0) {
        kpiArea.textContent = '0';
        kpiPlant.textContent = '0';
        kpiVolume.textContent = '0';
        kpiAvgVolume.textContent = '0';
        kpiTruck.textContent = '0';
        kpiAvgLoad.textContent = '0';
        return;
      }
      
      // Calculate KPIs
      const areas = new Set(filteredData.map(item => item.Area)).size;
      const plants = new Set(filteredData.map(item => item.Plant)).size;
      const totalVolume = filteredData.reduce((sum, item) => sum + (item.Volume || 0), 0);
      const avgVolume = totalVolume / filteredData.length;
      const trucks = new Set(filteredData.map(item => item['Truck ID'])).size;
      const avgLoad = totalVolume / (filteredData.length || 1);
      
      // Update KPI displays
      kpiArea.textContent = areas.toLocaleString();
      kpiPlant.textContent = plants.toLocaleString();
      kpiVolume.textContent = totalVolume.toLocaleString();
      kpiAvgVolume.textContent = avgVolume.toFixed(1);
      kpiTruck.textContent = trucks.toLocaleString();
      kpiAvgLoad.textContent = avgLoad.toFixed(1);
      
      log(`KPIs updated: ${areas} areas, ${plants} plants, ${totalVolume} volume`);
    }

    function updateCharts() {
      if (filteredData.length === 0) {
        // Show no data messages
        document.querySelectorAll('.no-data-message').forEach(el => {
          el.style.display = 'block';
        });
        return;
      }
      
      // Hide no data messages
      document.querySelectorAll('.no-data-message').forEach(el => {
        el.style.display = 'none';
      });
      
      // Create or update charts
      createVolumeByAreaChart();
      createVolumeByPlantChart();
      createAvgVolumeByPlantChart();
      createAvgVolumePerDayChart();
      createVolumePerTruckChart();
      createTotalTripPerTruckChart();
      createAvgLoadPerTruckChart();
      createAvgDistancePerPlantChart();
      createTrendVolumeByDistanceChart();
      createVolumePerSalesChart();
      createVolumePerCustomerChart();
      
      log('Charts updated');
    }

    function redrawAllCharts() {
      // Destroy all existing charts
      Object.values(charts).forEach(chart => {
        if (chart) {
          chart.destroy();
        }
      });
      
      charts = {};
      
      // Recreate charts
      updateCharts();
      
      log('All charts redrawn');
    }

    function formatDate(date) {
      return date.toLocaleDateString('id-ID', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }

    // Chart creation functions (simplified examples)
    function createVolumeByAreaChart() {
      const ctx = document.getElementById('canvas-volume-area');
      if (!ctx) return;
      
      // Sample data - replace with actual data processing
      const areaData = {};
      filteredData.forEach(item => {
        if (!areaData[item.Area]) areaData[item.Area] = 0;
        areaData[item.Area] += item.Volume || 0;
      });
      
      const labels = Object.keys(areaData);
      const data = Object.values(areaData);
      
      if (charts['volumeArea']) {
        charts['volumeArea'].destroy();
      }
      
      charts['volumeArea'] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Volume by Area',
            data: data,
            backgroundColor: highlightColors.slice(0, labels.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Volume (m³)'
              }
            }
          }
        }
      });
    }

    function createVolumeByPlantChart() {
      const ctx = document.getElementById('canvas-volume-plant');
      if (!ctx) return;
      
      // Sample data - replace with actual data processing
      const plantData = {};
      filteredData.forEach(item => {
        if (!plantData[item.Plant]) plantData[item.Plant] = 0;
        plantData[item.Plant] += item.Volume || 0;
      });
      
      const labels = Object.keys(plantData);
      const data = Object.values(plantData);
      
      if (charts['volumePlant']) {
        charts['volumePlant'].destroy();
      }
      
      charts['volumePlant'] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Volume by Plant',
            data: data,
            backgroundColor: highlightColors.slice(0, labels.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Volume (m³)'
              }
            }
          }
        }
      });
    }

    // Add other chart creation functions following the same pattern
    function createAvgVolumeByPlantChart() {
      // Implementation similar to above
    }

    function createAvgVolumePerDayChart() {
      // Implementation similar to above
    }

    function createVolumePerTruckChart() {
      // Implementation similar to above
    }

    function createTotalTripPerTruckChart() {
      // Implementation similar to above
    }

    function createAvgLoadPerTruckChart() {
      // Implementation similar to above
    }

    function createAvgDistancePerPlantChart() {
      // Implementation similar to above
    }

    function createTrendVolumeByDistanceChart() {
      // Implementation similar to above
    }

    function createVolumePerSalesChart() {
      // Implementation similar to above
    }

    function createVolumePerCustomerChart() {
      // Implementation similar to above
    }
  </script>
</body>
</html>
