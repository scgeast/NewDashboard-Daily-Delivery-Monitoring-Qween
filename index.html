<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Summary Daily Delivery</title>

  <!-- Favicon (minimal emoji) -->
  <link rel="icon" href="image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root {
      --primary: #3498db;
      --secondary: #2c3e50;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --gray: #95a5a6;
      --highlight-colors: (
        #e74c3c, #3498db, #2ecc71, #f39c12, #9b59b6,
        #1abc9c, #d35400, #2c3e50, #e67e22, #c0392b
      );
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      display: flex;
      background-color: #f5f7fa;
      color: #333;
    }

    /* SIDEBAR */
    #sidebar {
      width: 280px;
      background-color: var(--secondary);
      color: white;
      transition: all 0.3s ease;
      overflow-y: auto;
      height: 100vh;
      position: fixed;
      z-index: 100;
    }

    #sidebar.collapsed {
      width: 60px;
    }

    /* Toggle Button - Transparan, hanya ikon */
    #toggleSidebar {
      position: absolute;
      top: 10px;
      right: -20px;
      color: white;
      background: transparent;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 101;
      outline: none;
    }

    /* Upload Section */
    .upload-section {
      padding: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: center;
      position: relative;
    }

    .upload-section input[type="file"] {
      display: none;
    }

    .upload-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      display: inline-block;
      margin-bottom: 10px;
    }

    .upload-btn:hover {
      background-color: #2980b9;
    }

    .upload-info {
      font-size: 12px;
      color: #bdc3c7;
    }

    /* Loading Spinner */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      border-radius: 8px;
      z-index: 1000;
      display: none;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      font-weight: 500;
    }

    /* Error Message */
    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #e74c3c;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1001;
      display: none;
      animation: fadeInOut 3s ease-in-out;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }

    /* Filter Section */
    .filter-section {
      padding: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .filter-section h4 {
      margin-bottom: 10px;
      font-size: 14px;
      opacity: 0.9;
    }

    /* Custom Dropdown */
    .custom-dropdown {
      position: relative;
      width: 100%;
      margin-bottom: 10px;
    }

    .dropdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: white;
    }

    .dropdown-header i {
      font-size: 14px;
      opacity: 0.8;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background-color: rgba(255,255,255,0.9);
      border: 1px solid #ddd;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
    }

    .dropdown-menu option {
      padding: 8px 12px;
      color: #333;
      font-size: 14px;
      background: white;
      border: none;
      cursor: pointer;
    }

    .dropdown-menu option:hover {
      background-color: #f0f0f0;
    }

    .dropdown-menu option[selected] {
      background-color: var(--primary);
      color: white;
    }

    /* Data Label Toggle Switch */
    .data-label-toggle {
      display: flex;
      align-items: center;
      margin-top: 10px;
      font-size: 14px;
      gap: 10px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--primary);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    /* MAIN CONTENT */
    #main {
      flex-grow: 1;
      margin-left: 280px;
      padding: 20px;
      transition: margin-left 0.3s ease;
    }

    #main.collapsed {
      margin-left: 60px;
    }

    /* DASHBOARD HEADER */
    .dashboard-header-expanded {
      display: flex;
      flex-direction: column;
      background-color: var(--secondary);
      color: white;
      padding: 25px 20px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      position: relative;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 8px;
    }

    .header-center {
      flex: 1;
      text-align: center;
    }

    .header-center h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      line-height: 1.2;
      letter-spacing: -0.5px;
    }

    .header-right {
      flex-shrink: 0;
      text-align: right;
    }

    .last-update {
      font-size: 12px;
      opacity: 0.9;
      margin: 0;
    }

    .header-periode {
      font-size: 14px;
      opacity: 0.8;
      padding: 6px 0;
      border-top: 1px solid rgba(255,255,255,0.2);
      text-align: center;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .header-periode i {
      color: rgba(255,255,255,0.7);
      font-size: 16px;
    }

    /* KPI */
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .kpi-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }

    .kpi-card h3 {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 5px;
    }

    .kpi-card p {
      font-size: 24px;
      font-weight: bold;
      color: var(--dark);
    }

    /* TABS */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }

    .tab.active {
      background: white;
      font-weight: bold;
      border-bottom: 1px solid white;
      position: relative;
      z-index: 1;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 16px;
      margin-bottom: 15px;
      color: #2c3e50;
    }

    .highlight {
      font-weight: bold;
      color: #e74c3c;
    }

    /* FOOTER */
    .footer {
      text-align: center;
      padding: 15px;
      color: #7f8c8d;
      font-size: 14px;
      background-color: #f5f7fa;
      border-top: 1px solid #eee;
      margin-top: 20px;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      #sidebar {
        width: 60px;
      }
      #main {
        margin-left: 60px;
      }

      .header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .header-center {
        text-align: left;
        margin-left: 10px;
      }

      .header-right {
        margin-top: 4px;
        text-align: left;
      }

      .dashboard-header-expanded {
        padding: 20px 15px 10px;
      }

      .header-center h1 {
        font-size: 22px;
      }

      .header-periode {
        font-size: 13px;
      }

      .kpi-card p {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <div id="sidebar">
    <button class="toggle-btn" id="toggleSidebar">></button>

    <div class="upload-section">
      <input type="file" id="excelFile" accept=".xlsx,.xls" />
      <button class="upload-btn" onclick="document.getElementById('excelFile').click()">Upload Excel</button>
      <div class="upload-info">Min: 2KB | Max: 30MB</div>

      <!-- Loading Overlay -->
      <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Memproses data...</div>
      </div>

      <!-- Failure Message -->
      <div class="error-message" id="errorMessage">Gagal! File tidak valid atau tidak lengkap.</div>
    </div>

    <div class="filter-section">
      <h4>Tanggal</h4>
      <input type="date" id="startDate" />
      <input type="date" id="endDate" />

      <h4>Area</h4>
      <div class="custom-dropdown" id="areaDropdown">
        <div class="dropdown-header" onclick="toggleDropdown('areaDropdown')">
          <span id="areaLabel">Select All</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="dropdown-menu" id="areaMenu">
          <option value="all" selected>Select All</option>
        </div>
      </div>

      <h4>Pabrik</h4>
      <div class="custom-dropdown" id="plantDropdown">
        <div class="dropdown-header" onclick="toggleDropdown('plantDropdown')">
          <span id="plantLabel">Select All</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="dropdown-menu" id="plantMenu">
          <option value="all" selected>Select All</option>
        </div>
      </div>

      <h4>Tipe Truk</h4>
      <div class="custom-dropdown" id="truckTypeDropdown">
        <div class="dropdown-header" onclick="toggleDropdown('truckTypeDropdown')">
          <span id="truckTypeLabel">Select All</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="dropdown-menu" id="truckTypeMenu">
          <option value="all" selected>Select All</option>
        </div>
      </div>
    </div>

    <div class="data-label-toggle">
      <label class="toggle-switch">
        <input type="checkbox" id="dataLabelToggle" checked>
        <span class="toggle-slider"></span>
      </label>
      <span>Data Labels On</span>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div id="main">
    <!-- DASHBOARD HEADER -->
    <div class="dashboard-header-expanded">
      <div class="header-top">
        <div class="header-center">
          <h1 id="dashboardTitle">Summary Daily Delivery...Area (All)</h1>
        </div>
        <div class="header-right">
          <div class="last-update" id="lastUpdate">Last Update: --</div>
        </div>
      </div>
      <div class="header-periode">
        <i class="fas fa-calendar-alt"></i>
        <span id="periodeText">Periode: --</span>
      </div>
    </div>

    <!-- KPI -->
    <div class="kpi-container">
      <div class="kpi-card">
        <h3>Total Area</h3>
        <p id="kpiArea">0</p>
      </div>
      <div class="kpi-card">
        <h3>Total Pabrik</h3>
        <p id="kpiPlant">0</p>
      </div>
      <div class="kpi-card">
        <h3>Total Volume (mÂ³)</h3>
        <p id="kpiVolume">0</p>
      </div>
      <div class="kpi-card">
        <h3>Avg Volume (mÂ³)</h3>
        <p id="kpiAvgVolume">0</p>
      </div>
      <div class="kpi-card">
        <h3>Total Truk</h3>
        <p id="kpiTruck">0</p>
      </div>
      <div class="kpi-card">
        <h3>Avg Load/Truck (mÂ³)</h3>
        <p id="kpiAvgLoadTruck">0</p>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <div class="tab active" data-tab="logistic">LOGISTIC</div>
      <div class="tab" data-tab="sales">SALES AND CUSTOMER PERFORMANCE</div>
    </div>

    <!-- TAB CONTENT -->
    <div id="tabLogistic" class="tab-content active">
      <!-- A. Delivery -->
      <div class="chart-container">
        <h3 class="chart-title">A. Delivery</h3>
        <div id="volumeByArea" class="chart-container" style="display:none;">
          <h4 class="chart-title">A1. Volume by Area</h4>
          <canvas id="chartVolumeByArea"></canvas>
        </div>
        <div id="volumeByPlant" class="chart-container">
          <h4 class="chart-title">A2. Volume by Plant</h4>
          <canvas id="chartVolumeByPlant"></canvas>
        </div>
        <div id="avgVolumeByPlant" class="chart-container">
          <h4 class="chart-title">A3. Avg Volume by Plant</h4>
          <canvas id="chartAvgVolumeByPlant"></canvas>
        </div>
        <div id="avgVolumePerDay" class="chart-container">
          <h4 class="chart-title">A4. Avg Volume per Day</h4>
          <canvas id="chartAvgVolumePerDay"></canvas>
        </div>
      </div>

      <!-- B. Utilization Truck -->
      <div class="chart-container">
        <h3 class="chart-title">B. Utilization Truck</h3>
        <div id="volumePerTruck" class="chart-container">
          <h4 class="chart-title">B1. Volume per Truck</h4>
          <canvas id="chartVolumePerTruck"></canvas>
        </div>
        <div id="totalTripPerTruck" class="chart-container">
          <h4 class="chart-title">B2. Total Trip per Truck</h4>
          <canvas id="chartTotalTripPerTruck"></canvas>
        </div>
        <div id="avgLoadPerTruck" class="chart-container">
          <h4 class="chart-title">B3. Avg Load per Truck</h4>
          <canvas id="chartAvgLoadPerTruck"></canvas>
        </div>
      </div>

      <!-- C. Distance -->
      <div class="chart-container">
        <h3 class="chart-title">C. Distance</h3>
        <div id="avgDistancePerPlant" class="chart-container">
          <h4 class="chart-title">C1. Avg Distance per Plant</h4>
          <canvas id="chartAvgDistancePerPlant"></canvas>
        </div>
        <div id="trendVolumeByDistance" class="chart-container">
          <h4 class="chart-title">C2. Trend Volume by Distance</h4>
          <canvas id="chartTrendVolumeByDistance"></canvas>
        </div>
      </div>
    </div>

    <div id="tabSales" class="tab-content">
      <!-- A. Sales -->
      <div class="chart-container">
        <h3 class="chart-title">A. Volume per Sales</h3>
        <canvas id="chartVolumePerSales"></canvas>
      </div>

      <!-- B. Customer -->
      <div class="chart-container">
        <h3 class="chart-title">B. Volume per End Customer</h3>
        <canvas id="chartVolumePerCustomer"></canvas>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
      Summary Daily Delivery And Sales by L=23-51Xe.
    </div>
  </div>

  <script>
    // Global Variables
    let rawData = [];
    let filteredData = [];
    let charts = {};
    let dataLabelsEnabled = true;

    // Colors for highlighting (Top 10)
    const highlightColors = [
      '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
      '#1abc9c', '#d35400', '#2c3e50', '#e67e22', '#c0392b'
    ];

    // Helper: Normalize string to alphanumeric only
    function normalizeKey(str) {
      return String(str).toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const main = document.getElementById('main');
    const toggleBtn = document.getElementById('toggleSidebar');
    const excelFile = document.getElementById('excelFile');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const dataLabelToggle = document.getElementById('dataLabelToggle');
    const dashboardTitle = document.getElementById('dashboardTitle');
    const periodeText = document.getElementById('periodeText');
    const kpiArea = document.getElementById('kpiArea');
    const kpiPlant = document.getElementById('kpiPlant');
    const kpiVolume = document.getElementById('kpiVolume');
    const kpiAvgVolume = document.getElementById('kpiAvgVolume');
    const kpiTruck = document.getElementById('kpiTruck');
    const kpiAvgLoadTruck = document.getElementById('kpiAvgLoadTruck');
    const lastUpdate = document.getElementById('lastUpdate');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const errorMessage = document.getElementById('errorMessage');

    // Toggle Sidebar
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      main.classList.toggle('collapsed');
      toggleBtn.textContent = sidebar.classList.contains('collapsed') ? '>>' : '<<';
    });

    // Handle File Upload
    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      // Validasi ukuran file
      const fileSizeMB = file.size / (1024 * 1024);
      if (fileSizeMB < 0.002) {
        alert("File terlalu kecil! Minimal 2KB.");
        return;
      }
      if (fileSizeMB > 30) {
        alert("File terlalu besar! Maksimal 30MB.");
        return;
      }

      // Validasi ekstensi
      const ext = file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls');
      if (!ext) {
        loadingOverlay.style.display = 'none';
        errorMessage.textContent = "Gagal! Silakan unggah file berformat .xlsx atau .xls.";
        errorMessage.style.display = 'block';
        setTimeout(() => {
          errorMessage.style.display = 'none';
        }, 8000);
        return;
      }

      // Show loading
      loadingOverlay.style.display = 'flex';
      errorMessage.style.display = 'none';

      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, {
            type: 'array',
            bookSheets: true,
            cellNF: false,
            cellText: false,
            cellDates: true
          });

          if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
            throw new Error("Tidak ditemukan sheet dalam file.");
          }

          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];

          if (!worksheet || Object.keys(worksheet).length === 0) {
            throw new Error(`Sheet "${firstSheetName}" kosong.`);
          }

          // --- PARSE SEMUA BARIS SEBAGAI ARRAY 2D ---
          const jsonData = XLSX.utils.sheet_to_json(worksheet, {
            header: 1,
            defval: null,
            blankrows: false
          });

          if (!Array.isArray(jsonData) || jsonData.length === 0) {
            throw new Error("Tidak ada data dalam sheet.");
          }

          // Daftar kolom kunci yang harus ada
          const colMap = {
            'DP No': [
              'dp no', 'dp_no', 'dpno', 'dp-no', 'd_p_no', 'delivery note', 'dn',
              'dpno', 'dp no.', 'dp_no_', 'dp no ', 'dpno '
            ],
            'QTY': [
              'qty', 'quantity', 'volume', 'qte', 'qty (m3)', 'volume (m3)', 'jumlah',
              'qty_m3', 'volume_m3', 'qte_m3', 'qty m3', 'volume m3'
            ],
            'Area': [
              'area', 'region', 'wilayah', 'lokasi', 'zone', 'regional', 'area ',
              'area_', 'region_'
            ],
            'Plant Name': [
              'plant name', 'plant', 'plant_name', 'p_name', 'p-name', 'location',
              'site', 'plantname', 'plant-name', 'plant name ', 'plant_name_'
            ],
            'Truck No': [
              'truck no', 'truck_number', 'truckno', 'truck-no', 'trk_no', 'vehicle_id',
              'truck no ', 'truck_no_', 'truckno ', 'trk_no_', 'truckid'
            ],
            'Truck Type': [
              'truck type', 'truck_type', 'trk_type', 'type', 'vehicle_type', 'tipe_truk',
              'trucktype', 'type_truck', 'trk_type_', 'tipe truk'
            ],
            'Sales Man': [
              'sales man', 'salesman', 'sales', 'sales_rep', 'salesperson', 'penjualan',
              'sales_man', 'sales-man', 'sales ', 'sales_'
            ],
            'End Customer Name': [
              'end customer name', 'customer', 'end_customer', 'client', 'pelanggan',
              'cust_name', 'end_customer_name', 'customer_name', 'cust name',
              'end customer', 'pelanggan ', 'cust_'
            ],
            'Distance': [
              'distance', 'dist', 'jarak', 'km', 'distance_km', 'jarak_km',
              'distance ', 'dist_', 'jarak_', 'km_'
            ]
          };

          // Cari baris pertama yang mengandung minimal 1 kolom kunci
          const colMapKeys = Object.keys(colMap);
          let headerRowIndex = -1;

          for (let i = 0; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (!Array.isArray(row)) continue;

            let hasValidHeader = false;
            for (let j = 0; j < row.length; j++) {
              const cell = row[j];
              if (cell === null || cell === undefined) continue;

              const cleanCell = String(cell).trim().toLowerCase();
              for (const key of colMapKeys) {
                const aliases = colMap[key].map(normalizeKey);
                if (aliases.includes(cleanCell)) {
                  hasValidHeader = true;
                  break;
                }
              }
              if (hasValidHeader) break;
            }

            if (hasValidHeader) {
              headerRowIndex = i;
              break;
            }
          }

          if (headerRowIndex === -1) {
            throw new Error(
              "Gagal! Tidak ditemukan header yang valid. Pastikan file Anda memiliki salah satu dari:\n" +
              "DP No, QTY, Area, Plant Name, Truck No, Truck Type, Sales Man, End Customer Name, Distance"
            );
          }

          // Ambil header dari baris yang ditemukan
          const headers = jsonData[headerRowIndex].map(h => h ? String(h).trim() : '');

          // Buat mapping header asli â†’ standard key
          const headerToStandard = {};
          let foundAny = false;

          headers.forEach(header => {
            const cleanHeader = normalizeKey(header);
            for (const [standardKey, aliases] of Object.entries(colMap)) {
              const normalizedAliases = aliases.map(normalizeKey);
              if (normalizedAliases.includes(cleanHeader)) {
                headerToStandard[header] = standardKey;
                foundAny = true;
                break;
              }
            }
          });

          if (!foundAny) {
            throw new Error(
              "Gagal! Tidak ditemukan kolom wajib. Pastikan file Anda memiliki salah satu dari:\n" +
              "DP No, QTY, Area, Plant Name, Truck No, Truck Type, Sales Man, End Customer Name, Distance"
            );
          }

          // Ambil data dari baris setelah header
          rawData = jsonData.slice(headerRowIndex + 1).map(row => {
            if (!Array.isArray(row)) return {};
            const mappedRow = {};
            Object.keys(colMap).forEach(key => {
              let foundHeader = null;
              for (const [originalHeader, stdKey] of Object.entries(headerToStandard)) {
                if (stdKey === key) {
                  foundHeader = originalHeader;
                  break;
                }
              }
              const idx = headers.indexOf(foundHeader);
              mappedRow[key] = idx >= 0 && idx < row.length ? row[idx] : null;
            });
            return mappedRow;
          }).filter(row =>
            row['DP No'] !== null &&
            row['QTY'] !== null &&
            row['Area'] !== null &&
            row['Plant Name'] !== null &&
            row['Truck No'] !== null &&
            row['Truck Type'] !== null &&
            row['Sales Man'] !== null &&
            row['End Customer Name'] !== null &&
            row['Distance'] !== null
          ).map(row => ({
            ...row,
            'QTY': parseFloat(row['QTY']) || 0,
            'Distance': parseFloat(row['Distance']) || 0,
            'Date': extractDateFromRow(row)
          }));

          if (rawData.length === 0) {
            throw new Error("Semua baris gagal divalidasi. Periksa apakah data Anda lengkap dan benar.");
          }

          updateFilters();
          applyFilters();
          loadingOverlay.style.display = 'none';

        } catch (err) {
          console.error("Error reading Excel:", err);
          loadingOverlay.style.display = 'none';
          errorMessage.textContent = "Gagal! " + (err.message || "File tidak bisa dibaca. Coba simpan ulang sebagai .xlsx.");
          errorMessage.style.display = 'block';
          setTimeout(() => {
            errorMessage.style.display = 'none';
          }, 8000);
        }
      };

      reader.onerror = function () {
        loadingOverlay.style.display = 'none';
        errorMessage.textContent = "Gagal! Gagal membaca file. Coba gunakan file lain.";
        errorMessage.style.display = 'block';
        setTimeout(() => {
          errorMessage.style.display = 'none';
        }, 8000);
      };

      reader.readAsArrayBuffer(file);
    }

    function extractDateFromRow(row) {
      const dateCols = ['date', 'delivery date', 'delivery_date', 'tanggal'];
      for (let col in row) {
        if (dateCols.some(d => col.toLowerCase().includes(d))) {
          const val = row[col];
          if (typeof val === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}/.test(val)) {
            const [day, month, year] = val.split('/');
            return new Date(year, month - 1, day);
          } else if (val instanceof Date) {
            return val;
          } else if (typeof val === 'number') {
            return new Date(Math.round((val - 25569) * 86400 * 1000));
          }
        }
      }
      return new Date();
    }

    function updateFilters() {
      const areas = [...new Set(rawData.map(r => r.Area).filter(a => a))].sort();
      const plants = [...new Set(rawData.map(r => r['Plant Name']).filter(p => p))].sort();
      const truckTypes = [...new Set(rawData.map(r => r['Truck Type']).filter(t => t))].sort();

      clearDropdown('areaMenu');
      clearDropdown('plantMenu');
      clearDropdown('truckTypeMenu');

      addOption('areaMenu', "Select All", "all");
      areas.forEach(a => addOption('areaMenu', a, a));

      addOption('plantMenu', "Select All", "all");
      plants.forEach(p => addOption('plantMenu', p, p));

      addOption('truckTypeMenu', "Select All", "all");
      truckTypes.forEach(t => addOption('truckTypeMenu', t, t));
    }

    function clearDropdown(menuId) {
      const menu = document.getElementById(menuId);
      while (menu.children.length > 0) {
        menu.removeChild(menu.firstChild);
      }
    }

    function addOption(menuId, text, value) {
      const menu = document.getElementById(menuId);
      const option = document.createElement('option');
      option.text = text;
      option.value = value;
      menu.appendChild(option);
    }

    function toggleDropdown(id) {
      const dropdown = document.getElementById(id);
      const menu = dropdown.querySelector('.dropdown-menu');
      const icon = dropdown.querySelector('.dropdown-header i');
      const label = dropdown.querySelector('.dropdown-header span');

      if (menu.style.display === 'block') {
        menu.style.display = 'none';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
      } else {
        menu.style.display = 'block';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
      }
    }

    function applyFilters() {
      let filtered = [...rawData];

      const start = startDate.value ? new Date(startDate.value) : null;
      const end = endDate.value ? new Date(endDate.value) : null;

      if (start || end) {
        filtered = filtered.filter(row => {
          const rowDate = row.Date;
          if (!rowDate) return false;
          if (start && rowDate < start) return false;
          if (end && rowDate > end) return false;
          return true;
        });
      }

      const areaMenu = document.getElementById('areaMenu');
      const selectedAreas = Array.from(areaMenu.selectedOptions).map(o => o.value);
      if (!selectedAreas.includes('all')) {
        filtered = filtered.filter(row => selectedAreas.includes(row.Area));
      }

      const plantMenu = document.getElementById('plantMenu');
      const selectedPlants = Array.from(plantMenu.selectedOptions).map(o => o.value);
      if (!selectedPlants.includes('all')) {
        filtered = filtered.filter(row => selectedPlants.includes(row['Plant Name']));
      }

      const truckTypeMenu = document.getElementById('truckTypeMenu');
      const selectedTruckTypes = Array.from(truckTypeMenu.selectedOptions).map(o => o.value);
      if (!selectedTruckTypes.includes('all')) {
        filtered = filtered.filter(row => selectedTruckTypes.includes(row['Truck Type']));
      }

      filteredData = filtered;
      updateKPIs();
      updateDashboardTitle();
      updatePeriodeText();
      updateCharts();
      lastUpdate.textContent = `Last Update: ${new Date().toLocaleString()}`;
    }

    function updateKPIs() {
      const totalArea = [...new Set(filteredData.map(r => r.Area))].length;
      const totalPlant = [...new Set(filteredData.map(r => r['Plant Name']))].length;
      const totalVolume = filteredData.reduce((sum, r) => sum + r.QTY, 0);
      const avgVolume = totalVolume > 0 ? (totalVolume / filteredData.length).toFixed(2) : 0;
      const totalTruck = [...new Set(filteredData.map(r => r['Truck No']))].length;
      const avgLoadPerTruck = totalTruck > 0 ? (totalVolume / totalTruck).toFixed(2) : 0;

      kpiArea.textContent = totalArea;
      kpiPlant.textContent = totalPlant;
      kpiVolume.textContent = totalVolume.toFixed(2);
      kpiAvgVolume.textContent = avgVolume;
      kpiTruck.textContent = totalTruck;
      kpiAvgLoadTruck.textContent = avgLoadPerTruck;
    }

    function updateDashboardTitle() {
      const selectedAreas = Array.from(document.getElementById('areaMenu').selectedOptions).map(o => o.text);
      const areaDisplay = selectedAreas.includes('Select All') ? 'All' : selectedAreas.join(', ');
      dashboardTitle.textContent = `Summary Daily Delivery...Area (${areaDisplay})`;
    }

    function updatePeriodeText() {
      const start = startDate.value ? new Date(startDate.value).toLocaleDateString('id-ID') : '--';
      const end = endDate.value ? new Date(endDate.value).toLocaleDateString('id-ID') : '--';
      periodeText.textContent = `Periode: ${start} - ${end}`;
    }

    function updateCharts() {
      destroyAllCharts();

      if (!filteredData.length) return;

      const areaFilterSelected = Array.from(document.getElementById('areaMenu').selectedOptions).map(o => o.value);
      const showVolumeByArea = areaFilterSelected.includes('all');
      document.getElementById('volumeByArea').style.display = showVolumeByArea ? 'block' : 'none';

      if (showVolumeByArea) {
        createBarChart('chartVolumeByArea', 'Volume by Area', getGroupedData('Area', 'QTY'), true);
      }

      createBarChart('chartVolumeByPlant', 'Volume by Plant', getGroupedData('Plant Name', 'QTY'), true);
      createBarChart('chartAvgVolumeByPlant', 'Avg Volume by Plant', getGroupedData('Plant Name', 'QTY', true), true);
      createLineChart('chartAvgVolumePerDay', 'Avg Volume per Day', getDailyAvgVolume());
      createBarChart('chartVolumePerTruck', 'Volume per Truck', getGroupedData('Truck No', 'QTY'), true);
      createBarChart('chartTotalTripPerTruck', 'Total Trip per Truck', getTripCountByTruck(), true);

      const totalVol = filteredData.reduce((s, r) => s + r.QTY, 0);
      const totalTrucks = [...new Set(filteredData.map(r => r['Truck No']))].length;
      const avgLoad = totalTrucks > 0 ? totalVol / totalTrucks : 0;
      createSingleValueBarChart('chartAvgLoadPerTruck', 'Avg Load per Truck', avgLoad.toFixed(2), 'mÂ³');

      createBarChart('chartAvgDistancePerPlant', 'Avg Distance per Plant', getGroupedData('Plant Name', 'Distance', true), true);
      createScatterChart('chartTrendVolumeByDistance', 'Trend Volume by Distance', filteredData.map(r => ({ x: r.Distance, y: r.QTY })));

      createBarChart('chartVolumePerSales', 'Volume per Sales', getGroupedData('Sales Man', 'QTY'), true);
      createBarChart('chartVolumePerCustomer', 'Volume per End Customer', getGroupedData('End Customer Name', 'QTY'), true);
    }

    function getGroupedData(groupBy, metric, isAvg = false) {
      const map = new Map();
      filteredData.forEach(row => {
        const key = row[groupBy];
        if (!key) return;
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(parseFloat(row[metric]) || 0);
      });

      return Array.from(map.entries()).map(([key, values]) => ({
        label: key,
        value: isAvg ? (values.reduce((a,b)=>a+b,0)/values.length).toFixed(2) : values.reduce((a,b)=>a+b,0)
      })).sort((a,b) => b.value - a.value).slice(0, 10);
    }

    function getTripCountByTruck() {
      const tripMap = new Map();
      filteredData.forEach(row => {
        const key = `${row['Truck No']} - ${row['DP No']}`;
        const truckNo = row['Truck No'];
        if (!tripMap.has(truckNo)) tripMap.set(truckNo, new Set());
        tripMap.get(truckNo).add(key);
      });

      return Array.from(tripMap.entries()).map(([truck, trips]) => ({
        label: truck,
        value: trips.size
      })).sort((a,b) => b.value - a.value).slice(0, 10);
    }

    function getDailyAvgVolume() {
      const dailyMap = new Map();
      filteredData.forEach(row => {
        const dateStr = row.Date.toISOString().split('T')[0];
        if (!dailyMap.has(dateStr)) dailyMap.set(dateStr, { sum: 0, count: 0 });
        dailyMap.get(dateStr).sum += row.QTY;
        dailyMap.get(dateStr).count += 1;
      });

      return Array.from(dailyMap.entries())
        .map(([date, { sum, count }]) => ({
          date,
          avg: (sum / count).toFixed(2)
        }))
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    function destroyAllCharts() {
      Object.values(charts).forEach(chart => chart.destroy());
      charts = {};
    }

    function createBarChart(canvasId, title, data, enableHighlight = false) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = data.map(d => d.label);
      const values = data.map(d => d.value);

      const backgroundColors = enableHighlight
        ? labels.map((_, i) => highlightColors[i % highlightColors.length])
        : Array(labels.length).fill('#3498db');

      const datasets = [{
        label: title,
        data: values,
        backgroundColor: backgroundColors,
        borderColor: 'rgba(0,0,0,0.1)',
        borderWidth: 1,
      }];

      const config = {
        type: 'bar',
        data: {
          labels,
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: dataLabelsEnabled },
            title: { display: true, text: title, font: { size: 16 } },
          },
          scales: {
            y: { beginAtZero: true, ticks: { color: '#555' } },
            x: { ticks: { color: '#555', maxRotation: 45, minRotation: 0 } }
          }
        }
      };

      charts[canvasId] = new Chart(ctx, config);
    }

    function createSingleValueBarChart(canvasId, title, value, unit) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = ['Avg Load'];
      const values = [parseFloat(value)];

      const datasets = [{
        label: title,
        data: values,
        backgroundColor: '#2ecc71',
        borderColor: 'rgba(0,0,0,0.1)',
        borderWidth: 1,
      }];

      const config = {
        type: 'bar',
        data: {
          labels,
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: dataLabelsEnabled },
            title: { display: true, text: title, font: { size: 16 } },
            datalabels: {
              display: dataLabelsEnabled,
              formatter: (value) => `${value} ${unit}`,
              color: '#000',
              font: { weight: 'bold' }
            }
          },
          scales: {
            y: { display: false, beginAtZero: true },
            x: { display: false }
          }
        }
      };

      charts[canvasId] = new Chart(ctx, config);
    }

    function createLineChart(canvasId, title, data) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = data.map(d => d.date);
      const values = data.map(d => parseFloat(d.avg));

      const datasets = [{
        label: 'Avg Volume (mÂ³)',
        data: values,
        borderColor: '#3498db',
        backgroundColor: 'rgba(52, 152, 219, 0.1)',
        tension: 0.3,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 8
      }];

      const config = {
        type: 'line',
        data: {
          labels,
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: dataLabelsEnabled },
            title: { display: true, text: title, font: { size: 16 } },
          },
          scales: {
            y: { beginAtZero: true, ticks: { color: '#555' } },
            x: { ticks: { color: '#555', maxRotation: 45 } }
          }
        }
      };

      charts[canvasId] = new Chart(ctx, config);
    }

    function createScatterChart(canvasId, title, data) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const points = data.map(p => ({ x: p.x, y: p.y }));

      const datasets = [{
        label: 'Volume vs Distance',
        data: points,
        backgroundColor: 'rgba(52, 152, 219, 0.6)',
        borderColor: 'rgba(52, 152, 219, 0.8)',
        pointRadius: 4,
        pointHoverRadius: 8
      }];

      const config = {
        type: 'scatter',
        data: {
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: dataLabelsEnabled },
            title: { display: true, text: title, font: { size: 16 } },
          },
          scales: {
            x: { title: { display: true, text: 'Distance (km)' }, ticks: { color: '#555' } },
            y: { title: { display: true, text: 'Volume (mÂ³)' }, beginAtZero: true, ticks: { color: '#555' } }
          }
        }
      };

      charts[canvasId] = new Chart(ctx, config);
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');
      });
    });

    [startDate, endDate].forEach(el => {
      el.addEventListener('change', applyFilters);
    });

    dataLabelToggle.addEventListener('change', () => {
      dataLabelsEnabled = dataLabelToggle.checked;
      updateCharts();
    });

    window.addEventListener('load', () => {
      const today = new Date();
      const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
      startDate.valueAsDate = yesterday;
      endDate.valueAsDate = today;
      applyFilters();
    });

    excelFile.addEventListener('change', handleFileUpload);
  </script>
</body>
</html>
