<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Summary Daily Delivery</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root {
      --primary: #3498db;
      --secondary: #2c3e50;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --gray: #95a5a6;
      --highlight-colors: (
        #e74c3c, #3498db, #2ecc71, #f39c12, #9b59b6,
        #1abc9c, #d35400, #2c3e50, #e67e22, #c0392b
      );
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      display: flex;
      background-color: #f5f7fa;
      color: #333;
    }

    /* SIDEBAR */
    #sidebar {
      width: 280px;
      background-color: var(--secondary);
      color: white;
      transition: all 0.3s ease;
      overflow-y: auto;
      height: 100vh;
      position: fixed;
      z-index: 100;
    }

    #sidebar.collapsed {
      width: 60px;
    }

    /* Toggle Button - Transparan, hanya ikon */
    #toggleSidebar {
      position: absolute;
      top: 10px;
      right: -20px;
      color: white;
      background: transparent;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 101;
      outline: none;
    }

    /* Upload Section */
    .upload-section {
      padding: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    .upload-section input[type="file"] {
      display: none;
    }

    .upload-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      display: inline-block;
      margin-bottom: 10px;
    }

    .upload-btn:hover {
      background-color: #2980b9;
    }

    .upload-info {
      font-size: 12px;
      color: #bdc3c7;
    }

    /* Filter Section */
    .filter-section {
      padding: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .filter-section h4 {
      margin-bottom: 10px;
      font-size: 14px;
      opacity: 0.9;
    }

    .filter-section select, .filter-section input[type="date"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      background-color: rgba(255,255,255,0.1);
      color: white;
    }

    /* Data Label Toggle Switch (Modern Slider) */
    .data-label-toggle {
      display: flex;
      align-items: center;
      margin-top: 10px;
      font-size: 14px;
      gap: 10px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--primary);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    /* MAIN CONTENT */
    #main {
      flex-grow: 1;
      margin-left: 280px;
      padding: 20px;
      transition: margin-left 0.3s ease;
    }

    #main.collapsed {
      margin-left: 60px;
    }

    /* DASHBOARD HEADER (Diperluas dengan judul besar di tengah + ikon kalender) */
    .dashboard-header-expanded {
      display: flex;
      flex-direction: column;
      background-color: var(--secondary);
      color: white;
      padding: 25px 20px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      position: relative;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 8px;
    }

    .header-center {
      flex: 1;
      text-align: center;
    }

    .header-center h1 {
      margin: 0;
      font-size: 28px; /* Lebih besar */
      font-weight: 700;
      line-height: 1.2;
      letter-spacing: -0.5px;
    }

    .header-right {
      flex-shrink: 0;
      text-align: right;
    }

    .last-update {
      font-size: 12px;
      opacity: 0.9;
      margin: 0;
    }

    .header-periode {
      font-size: 14px;
      opacity: 0.8;
      padding: 6px 0;
      border-top: 1px solid rgba(255,255,255,0.2);
      text-align: center;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .header-periode i {
      color: rgba(255,255,255,0.7);
      font-size: 16px;
    }

    /* KPI */
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .kpi-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }

    .kpi-card h3 {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 5px;
    }

    .kpi-card p {
      font-size: 24px;
      font-weight: bold;
      color: var(--dark);
    }

    /* TABS */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }

    .tab.active {
      background: white;
      font-weight: bold;
      border-bottom: 1px solid white;
      position: relative;
      z-index: 1;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 16px;
      margin-bottom: 15px;
      color: #2c3e50;
    }

    .highlight {
      font-weight: bold;
      color: #e74c3c;
    }

    /* FOOTER */
    .footer {
      text-align: center;
      padding: 15px;
      color: #7f8c8d;
      font-size: 14px;
      background-color: #f5f7fa;
      border-top: 1px solid #eee;
      margin-top: 20px;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      #sidebar {
        width: 60px;
      }
      #main {
        margin-left: 60px;
      }

      .header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .header-center {
        text-align: left;
        margin-left: 10px;
      }

      .header-right {
        margin-top: 4px;
        text-align: left;
      }

      .dashboard-header-expanded {
        padding: 20px 15px 10px;
      }

      .header-center h1 {
        font-size: 22px;
      }

      .header-periode {
        font-size: 13px;
      }

      .kpi-card p {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <div id="sidebar">
    <button class="toggle-btn" id="toggleSidebar">></button>

    <div class="upload-section">
      <input type="file" id="excelFile" accept=".xlsx,.xls" />
      <button class="upload-btn" onclick="document.getElementById('excelFile').click()">Upload Excel</button>
      <div class="upload-info">Min: 2KB | Max: 30MB</div>
    </div>

    <div class="filter-section">
      <h4>Date Range</h4>
      <input type="date" id="startDate" />
      <input type="date" id="endDate" />

      <h4>Area</h4>
      <select id="filterArea" multiple size="1"> <!-- Size 1 = single line dropdown -->
        <option value="all">Select All</option>
      </select>

      <h4>Plant</h4>
      <select id="filterPlant" multiple size="1">
        <option value="all">Select All</option>
      </select>

      <h4>Truck Type</h4>
      <select id="filterTruckType" multiple size="1">
        <option value="all">Select All</option>
      </select>
    </div>

    <div class="data-label-toggle">
      <label class="toggle-switch">
        <input type="checkbox" id="dataLabelToggle" checked>
        <span class="toggle-slider"></span>
      </label>
      <span>Data Labels On</span>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div id="main">
    <!-- DASHBOARD HEADER (Diperluas dengan judul besar di tengah + ikon kalender) -->
    <div class="dashboard-header-expanded">
      <div class="header-top">
        <div class="header-center">
          <h1 id="dashboardTitle">Summary Daily Delivery...Area (All)</h1>
        </div>
        <div class="header-right">
          <div class="last-update" id="lastUpdate">Last Update: --</div>
        </div>
      </div>
      <div class="header-periode">
        <i class="fas fa-calendar-alt"></i>
        <span id="periodeText">Periode: --</span>
      </div>
    </div>

    <!-- KPI -->
    <div class="kpi-container">
      <div class="kpi-card">
        <h3>Total Area</h3>
        <p id="kpiArea">0</p>
      </div>
      <div class="kpi-card">
        <h3>Total Plant</h3>
        <p id="kpiPlant">0</p>
      </div>
      <div class="kpi-card">
        <h3>Total Volume (m³)</h3>
        <p id="kpiVolume">0</p>
      </div>
      <div class="kpi-card">
        <h3>Avg Volume (m³)</h3>
        <p id="kpiAvgVolume">0</p>
      </div>
      <div class="kpi-card">
        <h3>Total Truck</h3>
        <p id="kpiTruck">0</p>
      </div>
      <div class="kpi-card">
        <h3>Avg Load/Truck (m³)</h3>
        <p id="kpiAvgLoadTruck">0</p>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <div class="tab active" data-tab="logistic">LOGISTIC</div>
      <div class="tab" data-tab="sales">SALES AND CUSTOMER PERFORMANCE</div>
    </div>

    <!-- TAB CONTENT -->
    <div id="tabLogistic" class="tab-content active">
      <!-- A. Delivery -->
      <div class="chart-container">
        <h3 class="chart-title">A. Delivery</h3>
        <div id="volumeByArea" class="chart-container" style="display:none;">
          <h4 class="chart-title">A1. Volume by Area</h4>
          <canvas id="chartVolumeByArea"></canvas>
        </div>
        <div id="volumeByPlant" class="chart-container">
          <h4 class="chart-title">A2. Volume by Plant</h4>
          <canvas id="chartVolumeByPlant"></canvas>
        </div>
        <div id="avgVolumeByPlant" class="chart-container">
          <h4 class="chart-title">A3. Avg Volume by Plant</h4>
          <canvas id="chartAvgVolumeByPlant"></canvas>
        </div>
        <div id="avgVolumePerDay" class="chart-container">
          <h4 class="chart-title">A4. Avg Volume per Day</h4>
          <canvas id="chartAvgVolumePerDay"></canvas>
        </div>
      </div>

      <!-- B. Utilization Truck -->
      <div class="chart-container">
        <h3 class="chart-title">B. Utilization Truck</h3>
        <div id="volumePerTruck" class="chart-container">
          <h4 class="chart-title">B1. Volume per Truck</h4>
          <canvas id="chartVolumePerTruck"></canvas>
        </div>
        <div id="totalTripPerTruck" class="chart-container">
          <h4 class="chart-title">B2. Total Trip per Truck</h4>
          <canvas id="chartTotalTripPerTruck"></canvas>
        </div>
        <div id="avgLoadPerTruck" class="chart-container">
          <h4 class="chart-title">B3. Avg Load per Truck</h4>
          <canvas id="chartAvgLoadPerTruck"></canvas>
        </div>
      </div>

      <!-- C. Distance -->
      <div class="chart-container">
        <h3 class="chart-title">C. Distance</h3>
        <div id="avgDistancePerPlant" class="chart-container">
          <h4 class="chart-title">C1. Avg Distance per Plant</h4>
          <canvas id="chartAvgDistancePerPlant"></canvas>
        </div>
        <div id="trendVolumeByDistance" class="chart-container">
          <h4 class="chart-title">C2. Trend Volume by Distance</h4>
          <canvas id="chartTrendVolumeByDistance"></canvas>
        </div>
      </div>
    </div>

    <div id="tabSales" class="tab-content">
      <!-- A. Sales -->
      <div class="chart-container">
        <h3 class="chart-title">A. Volume per Sales</h3>
        <canvas id="chartVolumePerSales"></canvas>
      </div>

      <!-- B. Customer -->
      <div class="chart-container">
        <h3 class="chart-title">B. Volume per End Customer</h3>
        <canvas id="chartVolumePerCustomer"></canvas>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
      Summary Daily Delivery And Sales by L=23-51Xe.
    </div>
  </div>

  <script>
    // Global Variables
    let rawData = [];
    let filteredData = [];
    let charts = {};
    let dataLabelsEnabled = true;

    // Colors for highlighting (Top 10)
    const highlightColors = [
      '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
      '#1abc9c', '#d35400', '#2c3e50', '#e67e22', '#c0392b'
    ];

    // DOM Elements
    const sidebar = document.getElementById('sidebar');
    const main = document.getElementById('main');
    const toggleBtn = document.getElementById('toggleSidebar');
    const excelFile = document.getElementById('excelFile');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const filterArea = document.getElementById('filterArea');
    const filterPlant = document.getElementById('filterPlant');
    const filterTruckType = document.getElementById('filterTruckType');
    const dataLabelToggle = document.getElementById('dataLabelToggle');
    const dashboardTitle = document.getElementById('dashboardTitle');
    const periodeText = document.getElementById('periodeText');
    const kpiArea = document.getElementById('kpiArea');
    const kpiPlant = document.getElementById('kpiPlant');
    const kpiVolume = document.getElementById('kpiVolume');
    const kpiAvgVolume = document.getElementById('kpiAvgVolume');
    const kpiTruck = document.getElementById('kpiTruck');
    const kpiAvgLoadTruck = document.getElementById('kpiAvgLoadTruck');
    const lastUpdate = document.getElementById('lastUpdate');

    // Toggle Sidebar
    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      main.classList.toggle('collapsed');
      toggleBtn.textContent = sidebar.classList.contains('collapsed') ? '>>' : '<<';
    });

    // Handle File Upload
    excelFile.addEventListener('change', handleFileUpload);

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      const fileSizeMB = file.size / (1024 * 1024);
      if (fileSizeMB < 0.002) {
        alert("File too small! Minimum 2KB.");
        return;
      }
      if (fileSizeMB > 30) {
        alert("File too large! Maximum 30MB.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        const data = new Uint8Array(event.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        // Convert to JSON
        rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        // Parse headers (first row)
        const headers = rawData[0].map(h => String(h).trim());
        rawData = rawData.slice(1).map(row => {
          const obj = {};
          headers.forEach((header, idx) => {
            obj[header] = row[idx] !== undefined ? row[idx] : null;
          });
          return obj;
        });

        // Normalize column names (case-insensitive, trim)
        const colMap = {
          'DP No': ['dp no', 'dp_no', 'dpno', 'dp no'],
          'QTY': ['qty', 'quantity', 'qty (m3)', 'volume'],
          'Area': ['area', 'region'],
          'Plant Name': ['plant name', 'plant', 'plant_name'],
          'Truck No': ['truck no', 'truck_number', 'truckno'],
          'Truck Type': ['truck type', 'truck_type'],
          'Sales Man': ['sales man', 'salesman', 'sales'],
          'End Customer Name': ['end customer name', 'customer', 'end_customer'],
          'Distance': ['distance', 'dist']
        };

        // Map columns to standardized keys
        rawData = rawData.map(row => {
          const mappedRow = {};
          Object.keys(colMap).forEach(key => {
            const possibleKeys = colMap[key];
            let foundKey = null;
            for (const pk of possibleKeys) {
              for (const rk in row) {
                if (rk.toLowerCase().trim() === pk) {
                  foundKey = rk;
                  break;
                }
              }
              if (foundKey) break;
            }
            mappedRow[key] = foundKey ? row[foundKey] : null;
          });
          return mappedRow;
        });

        // Clean and convert types
        rawData = rawData.filter(row => 
          row['DP No'] && 
          row['QTY'] !== null && 
          row['Area'] !== null && 
          row['Plant Name'] !== null &&
          row['Truck No'] !== null &&
          row['Truck Type'] !== null &&
          row['Sales Man'] !== null &&
          row['End Customer Name'] !== null &&
          row['Distance'] !== null
        ).map(row => ({
          ...row,
          'QTY': parseFloat(row['QTY']) || 0,
          'Distance': parseFloat(row['Distance']) || 0,
          'Date': extractDateFromRow(row) // Try to extract date from any column with date-like values
        }));

        // Extract unique values for filters
        updateFilters();

        // Initial filter and render
        applyFilters();
      };
      reader.readAsArrayBuffer(file);
    }

    function extractDateFromRow(row) {
      // Try common date column names
      const dateCols = ['date', 'delivery date', 'delivery_date', 'tanggal'];
      for (let col in row) {
        if (dateCols.some(d => col.toLowerCase().includes(d))) {
          const val = row[col];
          if (typeof val === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}/.test(val)) {
            const [day, month, year] = val.split('/');
            return new Date(year, month - 1, day);
          } else if (val instanceof Date) {
            return val;
          } else if (typeof val === 'number') {
            // Excel serial date number
            return new Date(Math.round((val - 25569) * 86400 * 1000));
          }
        }
      }
      return new Date(); // fallback
    }

    function updateFilters() {
      const areas = [...new Set(rawData.map(r => r.Area).filter(a => a))].sort();
      const plants = [...new Set(rawData.map(r => r['Plant Name']).filter(p => p))].sort();
      const truckTypes = [...new Set(rawData.map(r => r['Truck Type']).filter(t => t))].sort();

      // Clear and repopulate selects
      clearSelect(filterArea);
      clearSelect(filterPlant);
      clearSelect(filterTruckType);

      // Add "Select All"
      addOption(filterArea, "Select All", "all");
      areas.forEach(a => addOption(filterArea, a, a));

      addOption(filterPlant, "Select All", "all");
      plants.forEach(p => addOption(filterPlant, p, p));

      addOption(filterTruckType, "Select All", "all");
      truckTypes.forEach(t => addOption(filterTruckType, t, t));
    }

    function clearSelect(selectElement) {
      while (selectElement.options.length > 0) {
        selectElement.remove(0);
      }
    }

    function addOption(selectElement, text, value) {
      const option = document.createElement('option');
      option.text = text;
      option.value = value;
      selectElement.add(option);
    }

    function applyFilters() {
      let filtered = [...rawData];

      // Date Filter
      const start = startDate.value ? new Date(startDate.value) : null;
      const end = endDate.value ? new Date(endDate.value) : null;

      if (start || end) {
        filtered = filtered.filter(row => {
          const rowDate = row.Date;
          if (!rowDate) return false;
          if (start && rowDate < start) return false;
          if (end && rowDate > end) return false;
          return true;
        });
      }

      // Area Filter
      const selectedAreas = Array.from(filterArea.selectedOptions).map(o => o.value);
      if (!selectedAreas.includes('all')) {
        filtered = filtered.filter(row => selectedAreas.includes(row.Area));
      }

      // Plant Filter
      const selectedPlants = Array.from(filterPlant.selectedOptions).map(o => o.value);
      if (!selectedPlants.includes('all')) {
        filtered = filtered.filter(row => selectedPlants.includes(row['Plant Name']));
      }

      // Truck Type Filter
      const selectedTruckTypes = Array.from(filterTruckType.selectedOptions).map(o => o.value);
      if (!selectedTruckTypes.includes('all')) {
        filtered = filtered.filter(row => selectedTruckTypes.includes(row['Truck Type']));
      }

      filteredData = filtered;

      // Update KPIs
      updateKPIs();

      // Update UI
      updateDashboardTitle();
      updatePeriodeText();
      updateCharts();

      // Update last update time
      lastUpdate.textContent = `Last Update: ${new Date().toLocaleString()}`;
    }

    function updateKPIs() {
      const totalArea = [...new Set(filteredData.map(r => r.Area))].length;
      const totalPlant = [...new Set(filteredData.map(r => r['Plant Name']))].length;
      const totalVolume = filteredData.reduce((sum, r) => sum + r.QTY, 0);
      const avgVolume = totalVolume > 0 ? (totalVolume / filteredData.length).toFixed(2) : 0;
      const totalTruck = [...new Set(filteredData.map(r => r['Truck No']))].length;
      const avgLoadPerTruck = totalTruck > 0 ? (totalVolume / totalTruck).toFixed(2) : 0;

      kpiArea.textContent = totalArea;
      kpiPlant.textContent = totalPlant;
      kpiVolume.textContent = totalVolume.toFixed(2);
      kpiAvgVolume.textContent = avgVolume;
      kpiTruck.textContent = totalTruck;
      kpiAvgLoadTruck.textContent = avgLoadPerTruck;
    }

    function updateDashboardTitle() {
      const selectedAreas = Array.from(filterArea.selectedOptions).map(o => o.text);
      const areaDisplay = selectedAreas.includes('Select All') ? 'All' : selectedAreas.join(', ');
      dashboardTitle.textContent = `Summary Daily Delivery...Area (${areaDisplay})`;
    }

    function updatePeriodeText() {
      const start = startDate.value ? new Date(startDate.value).toLocaleDateString('id-ID') : '--';
      const end = endDate.value ? new Date(endDate.value).toLocaleDateString('id-ID') : '--';
      periodeText.textContent = `Periode: ${start} - ${end}`;
    }

    // CHARTS RENDERING
    function updateCharts() {
      destroyAllCharts();

      if (!filteredData.length) return;

      // Show/Hide Volume by Area based on "Select All"
      const areaFilterSelected = Array.from(filterArea.selectedOptions).map(o => o.value);
      const showVolumeByArea = areaFilterSelected.includes('all');
      document.getElementById('volumeByArea').style.display = showVolumeByArea ? 'block' : 'none';

      // A1. Volume by Area
      if (showVolumeByArea) {
        createBarChart(
          'chartVolumeByArea',
          'Volume by Area',
          getGroupedData('Area', 'QTY'),
          true
        );
      }

      // A2. Volume by Plant
      createBarChart(
        'chartVolumeByPlant',
        'Volume by Plant',
        getGroupedData('Plant Name', 'QTY'),
        true
      );

      // A3. Avg Volume by Plant
      createBarChart(
        'chartAvgVolumeByPlant',
        'Avg Volume by Plant',
        getGroupedData('Plant Name', 'QTY', true),
        true
      );

      // A4. Avg Volume per Day (Line Chart)
      createLineChart(
        'chartAvgVolumePerDay',
        'Avg Volume per Day',
        getDailyAvgVolume()
      );

      // B1. Volume per Truck
      createBarChart(
        'chartVolumePerTruck',
        'Volume per Truck',
        getGroupedData('Truck No', 'QTY'),
        true
      );

      // B2. Total Trip per Truck (unique DP No per Truck)
      const tripData = getTripCountByTruck();
      createBarChart(
        'chartTotalTripPerTruck',
        'Total Trip per Truck',
        tripData,
        true
      );

      // B3. Avg Load per Truck (Total Volume / Total Truck)
      const totalVol = filteredData.reduce((s, r) => s + r.QTY, 0);
      const totalTrucks = [...new Set(filteredData.map(r => r['Truck No']))].length;
      const avgLoad = totalTrucks > 0 ? totalVol / totalTrucks : 0;
      createSingleValueBarChart(
        'chartAvgLoadPerTruck',
        'Avg Load per Truck',
        avgLoad.toFixed(2),
        'm³'
      );

      // C1. Avg Distance per Plant
      createBarChart(
        'chartAvgDistancePerPlant',
        'Avg Distance per Plant',
        getGroupedData('Plant Name', 'Distance', true),
        true
      );

      // C2. Trend Volume by Distance (Scatter)
      createScatterChart(
        'chartTrendVolumeByDistance',
        'Trend Volume by Distance',
        filteredData.map(r => ({ x: r.Distance, y: r.QTY }))
      );

      // SALES: Volume per Sales
      createBarChart(
        'chartVolumePerSales',
        'Volume per Sales',
        getGroupedData('Sales Man', 'QTY'),
        true
      );

      // CUSTOMER: Volume per End Customer
      createBarChart(
        'chartVolumePerCustomer',
        'Volume per End Customer',
        getGroupedData('End Customer Name', 'QTY'),
        true
      );
    }

    function getGroupedData(groupBy, metric, isAvg = false) {
      const map = new Map();
      filteredData.forEach(row => {
        const key = row[groupBy];
        if (!key) return;
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(parseFloat(row[metric]) || 0);
      });

      return Array.from(map.entries()).map(([key, values]) => ({
        label: key,
        value: isAvg ? (values.reduce((a,b)=>a+b,0)/values.length).toFixed(2) : values.reduce((a,b)=>a+b,0)
      })).sort((a,b) => b.value - a.value).slice(0, 10); // Top 10
    }

    function getTripCountByTruck() {
      const tripMap = new Map();
      filteredData.forEach(row => {
        const key = `${row['Truck No']} - ${row['DP No']}`;
        const truckNo = row['Truck No'];
        if (!tripMap.has(truckNo)) tripMap.set(truckNo, new Set());
        tripMap.get(truckNo).add(key);
      });

      return Array.from(tripMap.entries()).map(([truck, trips]) => ({
        label: truck,
        value: trips.size
      })).sort((a,b) => b.value - a.value).slice(0, 10); // Top 10
    }

    function getDailyAvgVolume() {
      const dailyMap = new Map();
      filteredData.forEach(row => {
        const dateStr = row.Date.toISOString().split('T')[0];
        if (!dailyMap.has(dateStr)) dailyMap.set(dateStr, { sum: 0, count: 0 });
        dailyMap.get(dateStr).sum += row.QTY;
        dailyMap.get(dateStr).count += 1;
      });

      return Array.from(dailyMap.entries())
        .map(([date, { sum, count }]) => ({
          date,
          avg: (sum / count).toFixed(2)
        }))
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    function destroyAllCharts() {
      Object.values(charts).forEach(chart => chart.destroy());
      charts = {};
    }

    function createBarChart(canvasId, title, data, enableHighlight = false) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = data.map(d => d.label);
      const values = data.map(d => d.value);

      const backgroundColors = enableHighlight
        ? labels.map((_, i) => highlightColors[i % highlightColors.length])
        : Array(labels.length).fill('#3498db');

      const datasets = [{
        label: title,
         values,
        backgroundColor: backgroundColors,
        borderColor: 'rgba(0,0,0,0.1)',
        borderWidth: 1,
      }];

      const config = {
        type: 'bar',
         { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: dataLabelsEnabled },
            title: { display: true, text: title, font: { size: 16 } },
          },
          scales: {
            y: { beginAtZero: true, ticks: { color: '#555' } },
            x: { ticks: { color: '#555', maxRotation: 45, minRotation: 0 } }
          }
        }
      };

      charts[canvasId] = new Chart(ctx, config);
    }

    function createSingleValueBarChart(canvasId, title, value, unit) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = ['Avg Load'];
      const values = [parseFloat(value)];

      const config = {
        type: 'bar',
         {
          labels,
          datasets: [{
            label: title,
             values,
            backgroundColor: '#2ecc71',
            borderColor: 'rgba(0,0,0,0.1)',
            borderWidth: 1,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: dataLabelsEnabled },
            title: { display: true, text: title, font: { size: 16 } },
            datalabels: {
              display: dataLabelsEnabled,
              formatter: (value) => `${value} ${unit}`,
              color: '#000',
              font: { weight: 'bold' }
            }
          },
          scales: {
            y: { display: false, beginAtZero: true },
            x: { display: false }
          }
        }
      };

      charts[canvasId] = new Chart(ctx, config);
    }

    function createLineChart(canvasId, title, data) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = data.map(d => d.date);
      const values = data.map(d => parseFloat(d.avg));

      const config = {
        type: 'line',
         {
          labels,
          datasets: [{
            label: 'Avg Volume (m³)',
             values,
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: dataLabelsEnabled },
            title: { display: true, text: title, font: { size: 16 } },
          },
          scales: {
            y: { beginAtZero: true, ticks: { color: '#555' } },
            x: { ticks: { color: '#555', maxRotation: 45 } }
          }
        }
      };

      charts[canvasId] = new Chart(ctx, config);
    }

    function createScatterChart(canvasId, title, data) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const points = data.map(p => ({ x: p.x, y: p.y }));

      const config = {
        type: 'scatter',
         {
          datasets: [{
            label: 'Volume vs Distance',
             points,
            backgroundColor: 'rgba(52, 152, 219, 0.6)',
            borderColor: 'rgba(52, 152, 219, 0.8)',
            pointRadius: 4,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: dataLabelsEnabled },
            title: { display: true, text: title, font: { size: 16 } },
          },
          scales: {
            x: { title: { display: true, text: 'Distance (km)' }, ticks: { color: '#555' } },
            y: { title: { display: true, text: 'Volume (m³)' }, beginAtZero: true, ticks: { color: '#555' } }
          }
        }
      };

      charts[canvasId] = new Chart(ctx, config);
    }

    // Tab Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');
      });
    });

    // Filter Event Listeners
    [startDate, endDate, filterArea, filterPlant, filterTruckType].forEach(el => {
      el.addEventListener('change', applyFilters);
    });

    dataLabelToggle.addEventListener('change', () => {
      dataLabelsEnabled = dataLabelToggle.checked;
      updateCharts();
    });

    // Initialize on load
    window.addEventListener('load', () => {
      // Auto-fill today's date range
      const today = new Date();
      const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
      startDate.valueAsDate = yesterday;
      endDate.valueAsDate = today;
      applyFilters();
    });
  </script>
</body>
</html>
